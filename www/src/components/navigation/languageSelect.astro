---
import { KnownLanguageCode, KNOWN_LANGUAGES } from "../../config";

export interface Props {
  language: KnownLanguageCode;
}
const { language } = Astro.props;
const languageName = KNOWN_LANGUAGES[language];
---

<div class="flex items-center gap-2">
  <svg viewBox="0 0 88.6 77.3" class="h-6 w-6 text-t3-purple-100" role="img">
    <path
      fill="currentColor"
      d="M61 24.6h7.9l18.7 51.6h-7.7l-5.4-15.5H54.3l-5.6 15.5h-7.2L61 24.6zM72.6 55l-8-22.8L56.3 55h16.3z"
    ></path>
    <path
      fill="currentColor"
      d="M53.6 60.6c-10-4-16-9-22-14 0 0 1.3 1.3 0 0-6 5-20 13-20 13l-4-6c8-5 10-6 19-13-2.1-1.9-12-13-13-19h8c4 9 10 14 10 14 10-8 10-19 10-19h8s-1 13-12 24c5 5 10 9 19 13l-3 7zm-52-44h56v-8h-23v-7h-9v7h-24v8z"
    ></path>
  </svg>

  <div class="relative">
    <button
      id="language-select-button"
      type="button"
      class="relative w-[15ch] h-10 cursor-pointer rounded-lg border dark:bg-t3-purple-200/10 hover:bg-t3-purple-200/75 dark:border-t3-purple-200/20 bg-t3-purple-200/50 py-2 pl-3 pr-10 text-left dark:hover:border-t3-purple-200/50 sm:text-sm"
      aria-haspopup="listbox"
      aria-expanded="true"
      aria-labelledby="listbox-label"
    >
      <span class="truncate">{languageName}</span>
      <span
        class="pointer-events-none absolute inset-y-0 right-0 pl-3 flex items-center pr-2"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 320 512"
          class="h-5 w-5 text-slate-900 dark:text-t3-purple-100"
          aria-hidden="true"
        >
          <path
            fill="currentColor"
            d="M137.4 374.6c12.5 12.5 32.8 12.5 45.3 0l128-128c9.2-9.2 11.9-22.9 6.9-34.9s-16.6-19.8-29.6-19.8L32 192c-12.9 0-24.6 7.8-29.6 19.8s-2.2 25.7 6.9 34.9l128 128z"
          ></path>
        </svg>
      </span>
    </button>

    <ul
      class="absolute h-0 transform dark:border-t3-purple-200/20 dark:hover:border-t3-purple-200/50 transition-transform z-10 mt-1 max-h-56 w-full overflow-auto rounded-lg bg-t3-purple-200/50 dark:bg-t3-purple-200/10"
      tabindex="-1"
      role="listbox"
      aria-labelledby="listbox-label"
      aria-activedescendant="listbox-option-3"
    >
      {
        Object.entries(KNOWN_LANGUAGES).map(([code, name]) => (
          <li
            class="cursor-pointer bg-t3-purple-200/50 py-1 pl-3 text-slate-900 hover:bg-t3-purple-200/75 dark:bg-t3-purple-200/10 dark:text-t3-purple-100 dark:hover:bg-t3-purple-200/20"
            role="option"
            data-value={code}
          >
            <span class="truncate">{name}</span>
          </li>
        ))
      }
    </ul>
  </div>
</div>

<script>
  const button = document.querySelector(
    "#language-select-button",
  ) as HTMLButtonElement;
  const list = button.nextElementSibling as HTMLUListElement;
  button?.addEventListener("click", () => {
    list.classList.toggle("h-0");
  });

  const listItems = list.querySelectorAll("li");
  listItems.forEach((item) => {
    item.addEventListener("click", (e) => {
      // @ts-ignore - why is this not typed?
      const lang = e.currentTarget.dataset.value;
      const [_1, _2, ...slug] = window.location.pathname.split("/");
      window.location.pathname = `/${lang}/${slug.join("/")}`;
    });
  });
</script>
